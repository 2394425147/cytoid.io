steps:
- name: 'gcr.io/$PROJECT_ID/git-lfs'
  args: ['init']
- name: 'gcr.io/$PROJECT_ID/git-lfs'
  args: ['remote', 'add', 'origin', 'https://github.com/Cytoid/cytoid.io.git']
- name: 'gcr.io/$PROJECT_ID/git-lfs'
  args: ['fetch']
- name: 'gcr.io/$PROJECT_ID/git-lfs'
  args: ['reset', '--soft', 'origin/$BRANCH_NAME']
- name: 'gcr.io/$PROJECT_ID/git-lfs'
  args: ['lfs', 'fetch']

- name: 'gcr.io/cloud-builders/yarn'
  args: ['install']
- name: 'gcr.io/cloud-builders/yarn'
  args: ['generate']
- name: 'gcr.io/cloud-builders/docker'
  args: ["build", "-t", "gcr.io/$PROJECT_ID/ssr", "."]
- name: 'gcr.io/cloud-builders/docker'
  args: ["push", "gcr.io/$PROJECT_ID/ssr"]
- name: 'gcr.io/cloud-builders/gsutil'
  args:
  # Parallel Uploading
  - "-m"
  #  Synchronize content of two buckets/directories
  - "rsync"
  # Synchronized recursively
  - "-r"
  # Compute Checksum
  - "-c"
  # Delete extra files
  - "-d"
  # Local Dir
  - "./.nuxt/dist/client"
  # Remote Bucket
  - "gs://static.cytoid.io"
- name: 'gcr.io/cloud-builders/gcloud'
  args:
  - 'beta'
  - 'run'
  - 'deploy'
  - 'ssr'
  - '--image'
  - 'gcr.io/$PROJECT_ID/ssr'
  - '--region'
  - 'us-central1'
  - '--platform'
  - 'managed'
images:
  - gcr.io/$PROJECT_ID/ssr
